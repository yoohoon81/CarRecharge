package ScheduleSystem;

import java.awt.BorderLayout;
import java.awt.EventQueue;

import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.EmptyBorder;
import javax.swing.event.CaretListener;
import javax.swing.table.DefaultTableModel;

import java.awt.GridBagLayout;
import javax.swing.JTextField;
import java.awt.GridBagConstraints;
import javax.swing.JTabbedPane;
import java.awt.Insets;
import javax.swing.JTable;
import javax.swing.JScrollPane;
import javax.swing.JButton;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Iterator;
import java.util.concurrent.ThreadLocalRandom;
import java.awt.event.ActionEvent;
import java.awt.Color;
import javax.swing.border.BevelBorder;
import javax.swing.BoxLayout;
import org.eclipse.wb.swing.FocusTraversalOnArray;

import jade.core.Profile;
import jade.core.ProfileImpl;
import jade.core.Runtime;
import jade.wrapper.AgentController;
import jade.wrapper.ContainerController;
import jade.wrapper.StaleProxyException;

import java.awt.Component;
import java.awt.GridLayout;
import com.jgoodies.forms.layout.FormLayout;
import com.jgoodies.forms.layout.ColumnSpec;
import com.jgoodies.forms.layout.RowSpec;
import javax.swing.JLabel;
import java.awt.FlowLayout;
import java.awt.Dimension;
import javax.swing.SwingConstants;
import java.awt.CardLayout;
import net.miginfocom.swing.MigLayout;
import javax.swing.GroupLayout;
import javax.swing.GroupLayout.Alignment;
import javax.swing.JTextArea;
import com.jgoodies.forms.layout.FormSpecs;
import java.awt.Rectangle;
import javax.swing.ScrollPaneConstants;

public class Dashboard extends JFrame {
	private JTable carTable;
	private static ContainerController mainCtrl;
	private static ArrayList<AgentController> carList = new ArrayList<AgentController>();
	private JTextField carNumberTextField;
	private JTextField numberOfBaysTextField;
	private JTable stationTable;
	private JTextField bayCapacityTextField;
	private JTextField outletPerBayTextField;
	private static AgentController schedulingAgentCtrl;
	private JButton runButton;
	private JTextArea messageTextArea;
	private JTextField speedTextField;
	private JPanel statusPanel;
	private JButton generateButton;
	private JPanel panelNorth;
	private AgentManager agentManager;
	/**
	 * Create the frame.
	 */
	public static void main(String[] args) throws StaleProxyException, InterruptedException {
		
		try {
			Dashboard frame = new Dashboard();
			frame.setVisible(true);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	private void InitUi()
	{
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		setBounds(100, 100, 1168, 779);
		getContentPane().setLayout(null);
		
		JTabbedPane tabbedPane = new JTabbedPane(JTabbedPane.TOP);
		tabbedPane.setBounds(0, 0, 1152, 961);
		getContentPane().add(tabbedPane);
		
		JPanel settingsPanel = new JPanel();
		tabbedPane.addTab("Settings", null, settingsPanel, null);
		tabbedPane.setEnabledAt(0, true);
		
		JPanel panel_1 = new JPanel();
		
		JLabel lblNewLabel_1 = new JLabel("Number of Bays");
		lblNewLabel_1.setBounds(7, 7, 92, 20);
		
		JLabel lblNewLabel_3 = new JLabel("Outlet per Bay");
		lblNewLabel_3.setBounds(7, 37, 80, 15);
		
		outletPerBayTextField = new JTextField();
		outletPerBayTextField.setBounds(116, 34, 64, 21);
		outletPerBayTextField.setText("4");
		outletPerBayTextField.setHorizontalAlignment(SwingConstants.LEFT);
		outletPerBayTextField.setColumns(10);
		
		JLabel lblNewLabel_2 = new JLabel("Bay Capacity KW");
		lblNewLabel_2.setBounds(7, 62, 98, 15);
		
		bayCapacityTextField = new JTextField();
		bayCapacityTextField.setBounds(116, 59, 65, 21);
		bayCapacityTextField.setText("1000");
		bayCapacityTextField.setColumns(10);
		
		numberOfBaysTextField = new JTextField();
		numberOfBaysTextField.setBounds(116, 7, 64, 21);
		numberOfBaysTextField.setText("2");
		numberOfBaysTextField.setColumns(10);
		settingsPanel.setLayout(new GridLayout(0, 3, 0, 0));
		
		JPanel panel = new JPanel();
		panel.setLayout(new FlowLayout(FlowLayout.CENTER, 5, 5));
		
		JLabel lblNewLabel = new JLabel("Number of Cars");
		panel.add(lblNewLabel);
		
		carNumberTextField = new JTextField();
		panel.add(carNumberTextField);
		carNumberTextField.setText("24");
		carNumberTextField.setEditable(false);
		carNumberTextField.setColumns(10);
		settingsPanel.add(panel);
		settingsPanel.add(panel_1);
		panel_1.setLayout(null);
		panel_1.add(lblNewLabel_1);
		panel_1.add(lblNewLabel_3);
		panel_1.add(outletPerBayTextField);
		panel_1.add(lblNewLabel_2);
		panel_1.add(bayCapacityTextField);
		panel_1.add(numberOfBaysTextField);
		
		JPanel panel_5 = new JPanel();
		settingsPanel.add(panel_5);
		panel_5.setLayout(null);
		
		JLabel lblNewLabel_4 = new JLabel("One simulating second is equal to                  ms");
		lblNewLabel_4.setBounds(12, 8, 307, 15);
		panel_5.add(lblNewLabel_4);
		
		speedTextField = new JTextField();
		speedTextField.setText("1");
		speedTextField.setBounds(215, 5, 44, 21);
		panel_5.add(speedTextField);
		speedTextField.setColumns(10);
		
		statusPanel = new JPanel(new BorderLayout());
		tabbedPane.addTab("Status", null, statusPanel, null);
		tabbedPane.setEnabledAt(1, true);
		//carsPanel.setLayout(new BoxLayout(carsPanel, BoxLayout.));
		panelNorth = new JPanel();
		statusPanel.add(panelNorth, BorderLayout.NORTH);
		
		generateButton = new JButton("Generate");
		panelNorth.add(generateButton);
		
		runButton = new JButton("Run");
		runButton.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				Thread t = new Thread(new Run());
				t.start();
			}
		});
		runButton.setEnabled(false);
		panelNorth.add(runButton);
		
		generateButton.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent arg0)  {

				Generate();				
			}
		});
		
		JPanel panelCentre = new JPanel();
		panelCentre.setSize(new Dimension(0, 900));
		panelCentre.setPreferredSize(new Dimension(10, 800));
		statusPanel.add(panelCentre, BorderLayout.CENTER);
		panelCentre.setLayout(new BorderLayout(0, 0));
		
		JPanel panel_2 = new JPanel();
		panelCentre.add(panel_2, BorderLayout.NORTH);
		panel_2.setLayout(new FlowLayout(FlowLayout.CENTER, 5, 5));
		
		carTable = new JTable();
		JScrollPane scrollPane = new JScrollPane(carTable);
		scrollPane.setMinimumSize(new Dimension(23, 15));
		panel_2.add(scrollPane);
		
		carTable.setModel(new DefaultTableModel(
			new Object[][] {
			},
			new String[] {
				"Id", "Required KW", "Charged %"
			}
		) {
			Class[] columnTypes = new Class[] {
				Integer.class, Integer.class, Integer.class
			};
			public Class getColumnClass(int columnIndex) {
				return columnTypes[columnIndex];
			}
		});
		
		JPanel panel_3 = new JPanel();
		panelCentre.add(panel_3, BorderLayout.CENTER);
		
		stationTable = new JTable();
		stationTable.setPreferredScrollableViewportSize(new Dimension(450, 200));
		JScrollPane scrollPane_1 = new JScrollPane(stationTable);
		panel_3.add(scrollPane_1);
		
		stationTable.setModel(new DefaultTableModel(
			new Object[][] {
			},
			new String[] {
				"Bay number", "Outlet number", "Charged KW", "Occupied by"
			}
		) {
			Class[] columnTypes = new Class[] {
				Integer.class, Integer.class, Integer.class, Integer.class
			};
			public Class getColumnClass(int columnIndex) {
				return columnTypes[columnIndex];
			}
		});
		
		/* South begin */
		
		JPanel panelEast = new JPanel();
		FlowLayout fl_panelEast = (FlowLayout) panelEast.getLayout();
		statusPanel.add(panelEast, BorderLayout.EAST);
		
		JPanel panel_4 = new JPanel();
		panelEast.add(panel_4);
		panel_4.setPreferredSize(new Dimension(650, 680));
		panel_4.setLayout(new FlowLayout(FlowLayout.CENTER, 5, 5));
		
		
		messageTextArea = new JTextArea(35, 75);
		messageTextArea.setEditable(false);
		JScrollPane scrollPane_2 = new JScrollPane(messageTextArea);
		scrollPane_2.setPreferredSize(new Dimension(650, 636));
		scrollPane_2.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_ALWAYS);
		scrollPane_2.setVerticalScrollBarPolicy(ScrollPaneConstants.VERTICAL_SCROLLBAR_ALWAYS);
		panel_4.add(scrollPane_2);
		
		statusPanel.setFocusTraversalPolicy(new FocusTraversalOnArray(new Component[]{panelNorth, panelCentre, panelEast}));
	}
	
	public Dashboard() {
		
		InitUi();		
		
		agentManager = AgentManager.getInstance();
		
		agentManager.SetMasterAgent(numberOfBaysTextField.getText(), bayCapacityTextField.getText(), outletPerBayTextField.getText())
			.SetLogField(messageTextArea)
			.StartMasterAgent();
	}
	
	public void Generate()
	{
		ArrayList<AgentController> cars = agentManager.StartCarAgents();
		
		agentManager.ResetBays();
		UpdateUi(null);		
	}
	
	
	
	

		
	private class Run implements Runnable
	{
		public void run() {
			int speed = Integer.parseInt(speedTextField.getText());
			agentManager.Run(speed);
			
			
			}		
			
			
		}
	}
	
	public void UpdateUi(ArrayList<String> messages)
	{		
		if(messages != null)
		{
			for(String message : messages)
				messageTextArea.append(message);							
		}
		
		DefaultTableModel model = (DefaultTableModel) carTable.getModel();
		//model.setRowCount(0);
		for(int i = 0; i < carList.size(); i++)
		{
			AgentController car = carList.get(i);
			try 
			{
				CarAgentInterface o2a = car.getO2AInterface(CarAgentInterface.class);
				if(model.getRowCount() < carList.size())
					model.addRow(new Object[] { o2a.getId(), o2a.getRequiredLoad(), o2a.getChargedPercent() });
				else
				{
					model.setValueAt(o2a.getId(), i, 0);
					model.setValueAt(o2a.getRequiredLoad(), i, 1);
					model.setValueAt(o2a.getChargedPercent(), i, 2);
				}
				//messageTextArea.append("[status] car["+o2a.getId()+"] requiredLoad=" + o2a.getRequiredLoad() + "\n");	
			} 
			catch (Exception ex)
			{
				ex.printStackTrace();				
			}
		}
		
		DefaultTableModel stationModel = (DefaultTableModel) stationTable.getModel();
		//stationModel.setRowCount(0);
		ArrayList<Bay> bays = GetBays();
	
		for(int i = 0; i < bays.size(); i++)
		{
			Bay bay = bays.get(i);
			try 
			{
				ArrayList<Outlet> outlets = bay.Outlets;
				for(int k = 0; k < outlets.size(); k++)
				{
					if(stationModel.getRowCount() < outlets.size() * bays.size())
						stationModel.addRow(new Object[] { bay.Id, outlets.get(k).Id, outlets.get(k).UsedLoad, outlets.get(k).CarIdUsedBy });
					else
					{
						stationModel.setValueAt(bay.Id, 					outlets.size() * i + k, 0);
						stationModel.setValueAt(outlets.get(k).Id, 			outlets.size() * i + k, 1);
						stationModel.setValueAt(outlets.get(k).UsedLoad, 	outlets.size() * i + k, 2);
						stationModel.setValueAt(outlets.get(k).CarIdUsedBy, outlets.size() * i + k, 3);
					}

					//messageTextArea.append("[status] bay["+bay.Id+"] outlet["+k+"] usedLoad="+outlets.get(k).UsedLoad+" isOccupiedBy=" + outlets.get(k).CarIdUsedBy + "\n");	
				}				
			} 
			catch (Exception ex)
			{
				ex.printStackTrace();				
			}
		}
		
		runButton.setEnabled(carList.size() > 0 && bays.size() > 0);
	}
	
}